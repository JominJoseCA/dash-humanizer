class DashHumanizerContent{constructor(){this.settings ={};this.selectionBubble = null;this.selectionTimeout = null;this.currentSelection = null;this.isInitialized = false;this.typingTimeout = null;this.observedElements = new WeakSet();this.isInteractingWithBubble = false;this.boundHandlers ={mouseup:null,touchend:null,selectionchange:null,mousedown:null};this.cachedElements = new WeakMap();}async init(){if(this.isInitialized)return;try{this.settings = await this.loadSettings();this.selectionBubble = new SelectionBubble();this.selectionBubble.onCopy =(text)=> this.handleCopy(text);this.selectionBubble.onReplace =(text)=> this.handleReplace(text);this.selectionBubble.onClose =()=> this.handleBubbleClose();this.selectionBubble.onInteractionStart =()=> this.isInteractingWithBubble = true;this.selectionBubble.onInteractionEnd =()=> this.isInteractingWithBubble = false;this.setupEventListeners();this.setupMessageListener();this.setupSettingsListener();this.isInitialized = true;ErrorHandler.log('Content script initialized');}catch(error){ErrorHandler.handle(error,'initialization',{showNotification:false});}}async loadSettings(){try{const result = await chrome.storage.sync.get([ 'enabled','autoHumanizeOnSelection','autoHumanizeOnType','convertEnDashes' ]);return{enabled:result.enabled !== undefined ? result.enabled:true,autoHumanizeOnSelection:result.autoHumanizeOnSelection !== undefined ? result.autoHumanizeOnSelection:true,autoHumanizeOnType:result.autoHumanizeOnType !== undefined ? result.autoHumanizeOnType:true,convertEnDashes:result.convertEnDashes !== undefined ? result.convertEnDashes:false};}catch(error){console.error('[Dash Humanizer] Error loading settings:',error);return{enabled:true,autoHumanizeOnSelection:true,autoHumanizeOnType:true,convertEnDashes:false};}}setupEventListeners(){this.boundHandlers.mouseup =(e)=> this.handleSelectionEvent(e);this.boundHandlers.touchend =(e)=> this.handleSelectionEvent(e);this.boundHandlers.selectionchange =()=> this.handleSelectionChange();this.boundHandlers.mousedown =(e)=> this.handleClickOutside(e);document.addEventListener('mouseup',this.boundHandlers.mouseup);document.addEventListener('touchend',this.boundHandlers.touchend);document.addEventListener('selectionchange',this.boundHandlers.selectionchange);document.addEventListener('mousedown',this.boundHandlers.mousedown);this.setupLiveTypingListeners();}setupLiveTypingListeners(){const observer = new MutationObserver((mutations)=>{mutations.forEach((mutation)=>{mutation.addedNodes.forEach((node)=>{if(node.nodeType === Node.ELEMENT_NODE){this.attachInputListeners(node);node.querySelectorAll('textarea,input[type="text"],[contenteditable="true"]').forEach((element)=>{this.attachInputListeners(element);});}});});});observer.observe(document.body,{childList:true,subtree:true});this.attachInputListeners(document.body);}attachInputListeners(rootElement){if(!rootElement)return;const editableElements = [];if(rootElement.nodeType === Node.ELEMENT_NODE){const element = rootElement;if(element.tagName === 'TEXTAREA' ||(element.tagName === 'INPUT' && element.type === 'text')|| element.isContentEditable){editableElements.push(element);}if(element.querySelectorAll){element.querySelectorAll('textarea,input[type="text"],[contenteditable="true"]').forEach((el)=>{editableElements.push(el);});}}editableElements.forEach((element)=>{if(this.observedElements.has(element))return;this.observedElements.add(element);element.addEventListener('input',(e)=> this.handleInputEvent(e));element.addEventListener('paste',(e)=> this.handlePasteEvent(e));});}handleInputEvent(event){if(!this.settings.enabled)return;if(!this.settings.autoHumanizeOnType)return;if(this.typingTimeout){clearTimeout(this.typingTimeout);this.typingTimeout = null;}this.typingTimeout = setTimeout(()=>{this.typingTimeout = null;this.processTypingTransformation(event.target);},100);}handlePasteEvent(event){if(!this.settings.enabled)return;if(!this.settings.autoHumanizeOnType)return;const pastedText = event.clipboardData?.getData('text/plain');if(!pastedText)return;if(!pastedText.includes('—')&& !pastedText.includes('–'))return;const humanizedText = window.DashHumanizer.humanize(pastedText,{convertEnDashes:this.settings.convertEnDashes});if(humanizedText === pastedText)return;event.preventDefault();const target = event.target;if(target.tagName === 'TEXTAREA' || target.tagName === 'INPUT'){this.insertTextInInput(target,humanizedText);}else if(target.isContentEditable){this.insertTextInContentEditableWithEditorDetection(target,humanizedText);}}insertTextInContentEditableWithEditorDetection(element,text){const selection = window.getSelection();if(!selection.rangeCount){this.insertTextInContentEditable(text);return;}const range = selection.getRangeAt(0);const editorType = this.detectRichTextEditor(range);if(editorType === 'gmail' && document.queryCommandSupported('insertText')){document.execCommand('insertText',false,text);}else{this.insertTextInContentEditable(text);if(editorType === 'notion'){element.dispatchEvent(new Event('change',{bubbles:true}));element.dispatchEvent(new KeyboardEvent('keyup',{bubbles:true}));}}}processTypingTransformation(element){if(!element)return;try{if(element.tagName === 'TEXTAREA' || element.tagName === 'INPUT'){this.transformTextInput(element);}else if(element.isContentEditable){this.transformContentEditable(element);}}catch(error){ErrorHandler.handle(error,'transformation',{showNotification:false});}}transformTextInput(element){const value = element.value;if(!value.includes('—')&& !value.includes('–'))return;if(window.DashHumanizer.isProtectedContext(value,element)){return;}const cursorPos = element.selectionStart;const cursorEnd = element.selectionEnd;const humanizedValue = window.DashHumanizer.humanize(value,{convertEnDashes:this.settings.convertEnDashes,element:element});if(humanizedValue === value)return;let newCursorPos = cursorPos;let newCursorEnd = cursorEnd;if(cursorPos === value.length){newCursorPos = humanizedValue.length;newCursorEnd = humanizedValue.length;}else{const textBeforeCursor = value.substring(0,cursorPos);const transformedBeforeCursor = window.DashHumanizer.humanize(textBeforeCursor,{convertEnDashes:this.settings.convertEnDashes});const offsetDiff = transformedBeforeCursor.length - textBeforeCursor.length;newCursorPos = cursorPos + offsetDiff;newCursorEnd = cursorEnd + offsetDiff;}element.value = humanizedValue;element.selectionStart = newCursorPos;element.selectionEnd = newCursorEnd;element.dispatchEvent(new Event('input',{bubbles:true}));}transformContentEditable(element){const selection = window.getSelection();if(!selection.rangeCount)return;const range = selection.getRangeAt(0);const cursorNode = range.startContainer;const cursorOffset = range.startOffset;const editorType = this.detectRichTextEditor(range);const textContent = element.textContent || '';if(!textContent.includes('—')&& !textContent.includes('–'))return;if(window.DashHumanizer.isProtectedContext(textContent,element)){return;}const humanizedText = window.DashHumanizer.humanize(textContent,{convertEnDashes:this.settings.convertEnDashes,element:element});if(humanizedText === textContent)return;if(element.childNodes.length === 1 && element.firstChild.nodeType === Node.TEXT_NODE){const textNode = element.firstChild;textNode.textContent = humanizedText;try{const newOffset = Math.min(cursorOffset,humanizedText.length);range.setStart(textNode,newOffset);range.setEnd(textNode,newOffset);selection.removeAllRanges();selection.addRange(range);}catch(error){ErrorHandler.warn('Cursor restoration failed,placing at end',error);range.selectNodeContents(element);range.collapse(false);selection.removeAllRanges();selection.addRange(range);}}else{this.transformTextNodes(element,cursorNode,cursorOffset);}element.dispatchEvent(new Event('input',{bubbles:true}));if(editorType === 'notion'){element.dispatchEvent(new Event('change',{bubbles:true}));element.dispatchEvent(new KeyboardEvent('keyup',{bubbles:true}));}}transformTextNodes(element,cursorNode,cursorOffset){const selection = window.getSelection();let newCursorNode = null;let newCursorOffset = 0;const walker = document.createTreeWalker(element,NodeFilter.SHOW_TEXT,null,false);let node;while(node = walker.nextNode()){const originalText = node.textContent;if(!originalText.includes('—')&& !originalText.includes('–'))continue;const transformedText = window.DashHumanizer.humanize(originalText,{convertEnDashes:this.settings.convertEnDashes});if(transformedText !== originalText){if(node === cursorNode){const lengthDiff = transformedText.length - originalText.length;newCursorNode = node;newCursorOffset = Math.min(cursorOffset + lengthDiff,transformedText.length);}node.textContent = transformedText;}}if(newCursorNode && selection.rangeCount > 0){try{const range = selection.getRangeAt(0);range.setStart(newCursorNode,newCursorOffset);range.setEnd(newCursorNode,newCursorOffset);selection.removeAllRanges();selection.addRange(range);}catch(error){ErrorHandler.warn('Cursor restoration error in text nodes',error);}}}insertTextInInput(element,text){const start = element.selectionStart;const end = element.selectionEnd;const value = element.value;const newCursorPos = start + text.length;element.value = value.substring(0,start)+ text + value.substring(end);element.selectionStart = newCursorPos;element.selectionEnd = newCursorPos;element.dispatchEvent(new Event('input',{bubbles:true}));}insertTextInContentEditable(text){const selection = window.getSelection();if(!selection.rangeCount)return;const range = selection.getRangeAt(0);range.deleteContents();const textNode = document.createTextNode(text);range.insertNode(textNode);range.setStartAfter(textNode);range.setEndAfter(textNode);selection.removeAllRanges();selection.addRange(range);}setupMessageListener(){chrome.runtime.onMessage.addListener((message,sender,sendResponse)=>{if(message.action === 'humanizeSelection'){this.handleContextMenuAction(message.text);sendResponse({success:true});}else if(message.action === 'settingsUpdated'){this.settings = message.settings;sendResponse({success:true});}return true;});}setupSettingsListener(){chrome.storage.onChanged.addListener(async(changes,areaName)=>{if(areaName !== 'sync')return;const settingsKeys = ['enabled','autoHumanizeOnSelection','autoHumanizeOnType','convertEnDashes'];const hasSettingsChange = settingsKeys.some(key => changes[key]);if(hasSettingsChange){this.settings = await this.loadSettings();console.log('[Dash Humanizer] Settings updated:',this.settings);}});}handleSelectionEvent(event){if(this.selectionTimeout){clearTimeout(this.selectionTimeout);this.selectionTimeout = null;}this.selectionTimeout = setTimeout(()=>{this.selectionTimeout = null;this.processTextSelection();},150);}processTextSelection(){if(!this.settings.enabled)return;if(!this.settings.autoHumanizeOnSelection)return;const selection = window.getSelection();if(!selection || selection.isCollapsed){this.selectionBubble.hide();return;}const selectedText = selection.toString().trim();if(!selectedText){this.selectionBubble.hide();return;}if(!selectedText.includes('—')&& !selectedText.includes('–')&& !selectedText.includes('-')){this.selectionBubble.hide();return;}try{const range = selection.getRangeAt(0);const container = range.commonAncestorContainer;const element = container.nodeType === Node.ELEMENT_NODE ? container:container.parentElement;if(window.DashHumanizer.isProtectedContext(selectedText,element)){this.selectionBubble.hide();return;}}catch(error){ErrorHandler.warn('Unable to check selection context,skipping',error);this.selectionBubble.hide();return;}let loadingIndicator = null;const startTime = Date.now();if(selectedText.length > 50000){loadingIndicator = this.showLoadingIndicator();}const humanizedText = window.DashHumanizer.humanize(selectedText,{convertEnDashes:this.settings.convertEnDashes,onProgress:(processed,total)=>{if(loadingIndicator){const percent = Math.round((processed / total)* 100);loadingIndicator.textContent = `Processing... ${percent}%`;}}});if(loadingIndicator){const elapsed = Date.now()- startTime;if(elapsed < 500){loadingIndicator.remove();}else{setTimeout(()=> loadingIndicator.remove(),200);}}if(humanizedText === selectedText){this.selectionBubble.hide();return;}const range = selection.getRangeAt(0);const rect = range.getBoundingClientRect();this.currentSelection ={selection:selection,range:range,text:selectedText,humanizedText:humanizedText};this.selectionBubble.show(selectedText,humanizedText,rect);}showLoadingIndicator(){const indicator = document.createElement('div');indicator.style.cssText = ` position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:16px 24px;border-radius:8px;z-index:2147483647;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:14px;`;indicator.textContent = 'Processing...';document.body.appendChild(indicator);return indicator;}handleSelectionChange(){const selection = window.getSelection();if(!selection || selection.isCollapsed){setTimeout(()=>{if(this.isInteractingWithBubble)return;if(!this.selectionBubble.isShowing())return;const selection = window.getSelection();if(!selection || selection.isCollapsed){this.selectionBubble.hide();}},300);}}handleClickOutside(event){if(!this.selectionBubble.isShowing())return;const bubbleContainer = this.selectionBubble.container;if(bubbleContainer && !bubbleContainer.contains(event.target)){setTimeout(()=>{const selection = window.getSelection();if(!selection || selection.isCollapsed){this.selectionBubble.hide();}},200);}}async handleCopy(humanizedText){try{await navigator.clipboard.writeText(humanizedText);ErrorHandler.log('Text copied to clipboard');this.selectionBubble.hide();}catch(error){ErrorHandler.handle(error,'clipboard-write',{fallback:()=>{this.showCopyModal(humanizedText);}});}}handleReplace(humanizedText){if(!this.currentSelection){ErrorHandler.warn('No selection stored for replacement');return;}try{const range = this.currentSelection.range;const startContainer = range.startContainer;let editableElement = null;let node = startContainer;while(node && node !== document.body){if(node.nodeType === Node.ELEMENT_NODE){const element = node;if(element.tagName === 'TEXTAREA' || element.tagName === 'INPUT'){editableElement = element;break;}if(element.isContentEditable){editableElement = element;break;}}node = node.parentNode;}if(!editableElement){ErrorHandler.handle(new Error('Non-editable field'),'dom-manipulation',{fallback:()=>{this.showCopyModal(humanizedText);}});return;}if(editableElement.tagName === 'TEXTAREA' || editableElement.tagName === 'INPUT'){this.replaceInTextInput(editableElement,humanizedText);}else if(editableElement.isContentEditable){this.replaceInContentEditable(range,humanizedText);}this.selectionBubble.hide();ErrorHandler.log('Text replaced successfully');}catch(error){ErrorHandler.handle(error,'dom-manipulation',{fallback:()=>{this.showCopyModal(humanizedText);}});}}replaceInTextInput(element,newText){const start = element.selectionStart;const end = element.selectionEnd;const value = element.value;const newCursorPos = start + newText.length;element.value = value.substring(0,start)+ newText + value.substring(end);element.selectionStart = newCursorPos;element.selectionEnd = newCursorPos;element.dispatchEvent(new Event('input',{bubbles:true}));}replaceInContentEditable(range,newText){const editorType = this.detectRichTextEditor(range);if(editorType === 'gmail'){this.replaceInGmail(range,newText);}else if(editorType === 'notion'){this.replaceInNotion(range,newText);}else if(editorType === 'google-docs'){this.replaceInGoogleDocs(range,newText);}else{this.replaceInStandardContentEditable(range,newText);}}detectRichTextEditor(range){const container = range.commonAncestorContainer;let element = container.nodeType === Node.ELEMENT_NODE ? container:container.parentElement;while(element && element !== document.body){if(element.getAttribute('role')=== 'textbox' &&(element.getAttribute('aria-label')?.includes('Message Body')|| element.getAttribute('g_editable')=== 'true' || element.closest('[role="main"]')?.querySelector('[aria-label*="Message"]'))){return 'gmail';}if(element.classList.contains('notion-page-content')|| element.classList.contains('notion-text-block')|| element.getAttribute('data-block-id')|| element.closest('[class*="notion"]')){return 'notion';}if(element.classList.contains('kix-cursor')|| element.classList.contains('kix-lineview')|| element.classList.contains('kix-paragraphrenderer')|| document.querySelector('.docs-texteventtarget-iframe')){return 'google-docs';}element = element.parentElement;}return 'standard';}replaceInGmail(range,newText){try{const selection = window.getSelection();selection.removeAllRanges();selection.addRange(range);if(document.queryCommandSupported('insertText')){document.execCommand('insertText',false,newText);}else{this.replaceInStandardContentEditable(range,newText);}}catch(error){ErrorHandler.warn('Gmail replacement error,using fallback',error);this.replaceInStandardContentEditable(range,newText);}}replaceInNotion(range,newText){try{this.replaceInStandardContentEditable(range,newText);const editableElement = range.commonAncestorContainer.parentElement;if(editableElement){editableElement.dispatchEvent(new Event('input',{bubbles:true}));editableElement.dispatchEvent(new Event('change',{bubbles:true}));editableElement.dispatchEvent(new KeyboardEvent('keyup',{bubbles:true}));}}catch(error){ErrorHandler.warn('Notion replacement error,using fallback',error);this.replaceInStandardContentEditable(range,newText);}}replaceInGoogleDocs(range,newText){try{const docsIframe = document.querySelector('.docs-texteventtarget-iframe');if(docsIframe && docsIframe.contentDocument){const iframeDoc = docsIframe.contentDocument;const iframeSelection = iframeDoc.getSelection();if(iframeSelection && iframeSelection.rangeCount > 0){const iframeRange = iframeSelection.getRangeAt(0);iframeRange.deleteContents();const textNode = iframeDoc.createTextNode(newText);iframeRange.insertNode(textNode);iframeRange.setStartAfter(textNode);iframeRange.setEndAfter(textNode);iframeSelection.removeAllRanges();iframeSelection.addRange(iframeRange);return;}}this.replaceInStandardContentEditable(range,newText);}catch(error){ErrorHandler.handle(error,'cross-origin',{showNotification:false,fallback:()=>{this.replaceInStandardContentEditable(range,newText);}});}}replaceInStandardContentEditable(range,newText){range.deleteContents();const textNode = document.createTextNode(newText);range.insertNode(textNode);range.setStartAfter(textNode);range.setEndAfter(textNode);const selection = window.getSelection();selection.removeAllRanges();selection.addRange(range);const editableElement = range.commonAncestorContainer.parentElement;if(editableElement){editableElement.dispatchEvent(new Event('input',{bubbles:true}));}}handleBubbleClose(){this.currentSelection = null;}removeEventListeners(){if(this.boundHandlers.mouseup){document.removeEventListener('mouseup',this.boundHandlers.mouseup);}if(this.boundHandlers.touchend){document.removeEventListener('touchend',this.boundHandlers.touchend);}if(this.boundHandlers.selectionchange){document.removeEventListener('selectionchange',this.boundHandlers.selectionchange);}if(this.boundHandlers.mousedown){document.removeEventListener('mousedown',this.boundHandlers.mousedown);}}handleContextMenuAction(selectedText){if(!this.settings.enabled){console.log('[Dash Humanizer] Extension is disabled,ignoring context menu action');return;}const selection = window.getSelection();if(!selection || selection.isCollapsed){console.log('[Dash Humanizer] No text selected for context menu action');return;}const text = selectedText || selection.toString();const humanizedText = window.DashHumanizer.humanize(text,{convertEnDashes:this.settings.convertEnDashes});const range = selection.getRangeAt(0);const startContainer = range.startContainer;let editableElement = null;let node = startContainer;while(node && node !== document.body){if(node.nodeType === Node.ELEMENT_NODE){const element = node;if(element.tagName === 'TEXTAREA' || element.tagName === 'INPUT'){editableElement = element;break;}if(element.isContentEditable){editableElement = element;break;}}node = node.parentNode;}if(editableElement){this.currentSelection ={selection:selection,range:range,text:text,humanizedText:humanizedText};if(editableElement.tagName === 'TEXTAREA' || editableElement.tagName === 'INPUT'){this.replaceInTextInput(editableElement,humanizedText);}else if(editableElement.isContentEditable){this.replaceInContentEditable(range,humanizedText);}console.log('[Dash Humanizer] Text replaced via context menu');}else{this.showCopyModal(humanizedText);}}showCopyModal(humanizedText){const modal = document.createElement('div');modal.setAttribute('role','dialog');modal.setAttribute('aria-modal','true');modal.setAttribute('aria-labelledby','modal-title');modal.style.cssText = ` position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:2147483647;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;`;const modalContent = document.createElement('div');modalContent.style.cssText = ` background:white;border-radius:8px;padding:24px;max-width:500px;box-shadow:0 4px 12px rgba(0,0,0,0.15);`;modalContent.innerHTML = ` <h3 id="modal-title" style="margin:0 0 12px 0;font-size:18px;color:#333;">Humanized Text</h3> <p id="modal-text" style="margin:0 0 16px 0;font-size:14px;color:#666;line-height:1.4;word-wrap:break-word;"> ${this.escapeHtml(humanizedText)}</p> <div role="group" aria-label="Actions" style="display:flex;gap:8px;justify-content:flex-end;"> <button id="modal-close" type="button" aria-label="Close dialog" style="padding:8px 16px;border:1px solid #d0d0d0;background:white;border-radius:4px;cursor:pointer;font-size:14px;"> Close </button> <button id="modal-copy" type="button" aria-label="Copy humanized text to clipboard" style="padding:8px 16px;border:1px solid #4285f4;background:#4285f4;color:white;border-radius:4px;cursor:pointer;font-size:14px;"> Copy </button> </div> <div role="status" aria-live="polite" aria-atomic="true" id="modal-status" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0;"></div> `;modal.appendChild(modalContent);document.body.appendChild(modal);const closeBtn = modalContent.querySelector('#modal-close');closeBtn.addEventListener('click',()=>{modal.remove();});const copyBtn = modalContent.querySelector('#modal-copy');const statusElement = modalContent.querySelector('#modal-status');copyBtn.addEventListener('click',async()=>{try{await navigator.clipboard.writeText(humanizedText);copyBtn.textContent = 'Copied!';copyBtn.setAttribute('aria-label','Text copied to clipboard');if(statusElement){statusElement.textContent = 'Text copied to clipboard';}setTimeout(()=>{modal.remove();},1000);}catch(error){ErrorHandler.handle(error,'clipboard-write');if(statusElement){statusElement.textContent = 'Failed to copy text. Please try again.';}}});modal.addEventListener('click',(e)=>{if(e.target === modal){modal.remove();}});const handleKeyDown =(e)=>{if(e.key === 'Escape'){modal.remove();document.removeEventListener('keydown',handleKeyDown);}else if(e.key === 'Tab'){const focusableElements = modalContent.querySelectorAll('button');const firstElement = focusableElements[0];const lastElement = focusableElements[focusableElements.length - 1];if(e.shiftKey){if(document.activeElement === firstElement){e.preventDefault();lastElement.focus();}}else{if(document.activeElement === lastElement){e.preventDefault();firstElement.focus();}}}};document.addEventListener('keydown',handleKeyDown);copyBtn.focus();if(statusElement){setTimeout(()=>{statusElement.textContent = 'Humanized text dialog opened. Use Tab to navigate between buttons. Press Escape to close.';},100);}}escapeHtml(text){if(typeof text !== 'string'){return '';}const div = document.createElement('div');div.textContent = text;return div.innerHTML;}}if(document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',()=>{const contentScript = new DashHumanizerContent();contentScript.init();});}else{const contentScript = new DashHumanizerContent();contentScript.init();}