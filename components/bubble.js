class SelectionBubble{constructor(){this.container = null;this.shadowRoot = null;this.isVisible = false;this.onCopy = null;this.onReplace = null;this.onClose = null;this.onInteractionStart = null;this.onInteractionEnd = null;this.currentOriginalText = '';this.currentHumanizedText = '';this.isExpanded = false;}init(){if(this.container)return;this.container = document.createElement('div');this.container.className = 'dash-humanizer-bubble-container';this.shadowRoot = this.container.attachShadow({mode:'open'});this.shadowRoot.appendChild(this.createStyles());document.body.appendChild(this.container);}createStyles(){const style = document.createElement('style');style.textContent = ` .bubble{position:fixed;z-index:2147483647;background:white;border:1px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);padding:12px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;max-width:400px;opacity:0;transition:opacity 150ms ease-in;display:none;}.bubble.visible{display:block;opacity:1;}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0;}.bubble-content{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}.bubble-column{min-width:0;}.bubble-label{font-size:11px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;}.bubble-text{font-size:14px;line-height:1.4;color:#333;word-wrap:break-word;overflow-wrap:break-word;}.bubble-text.truncated{max-height:60px;overflow:hidden;position:relative;}.bubble-text.truncated::after{content:'...';position:absolute;bottom:0;right:0;background:white;padding-left:4px;}.show-more{font-size:12px;color:#4285f4;cursor:pointer;margin-top:4px;display:inline-block;text-decoration:none;}.show-more:hover{text-decoration:underline;}.bubble-buttons{display:flex;gap:8px;justify-content:flex-end;}.bubble-button{padding:6px 12px;border-radius:4px;border:1px solid #d0d0d0;background:white;cursor:pointer;font-size:13px;font-family:inherit;color:#333;transition:background 100ms ease;}.bubble-button:hover{background:#f5f5f5;}.bubble-button:focus{outline:2px solid #4285f4;outline-offset:2px;}.bubble-button:active{background:#e8e8e8;}.bubble-button.primary{background:#4285f4;color:white;border-color:#4285f4;}.bubble-button.primary:hover{background:#3367d6;}.bubble-button.primary:active{background:#2851a3;}`;return style;}createBubbleHTML(originalText,humanizedText){const bubble = document.createElement('div');bubble.className = 'bubble';bubble.setAttribute('role','dialog');bubble.setAttribute('aria-label','Text humanization preview');bubble.setAttribute('aria-modal','true');const shouldTruncate = originalText.length > 100;const displayOriginal = shouldTruncate && !this.isExpanded ? originalText.substring(0,100):originalText;const displayHumanized = shouldTruncate && !this.isExpanded ? humanizedText.substring(0,100):humanizedText;bubble.innerHTML = ` <div class="bubble-content" role="group" aria-label="Text comparison"> <div class="bubble-column"> <div class="bubble-label" id="original-label">Original</div> <div class="bubble-text ${shouldTruncate && !this.isExpanded ? 'truncated':''}" id="original-text" role="region" aria-labelledby="original-label"> ${this.escapeHtml(displayOriginal)}</div> </div> <div class="bubble-column"> <div class="bubble-label" id="humanized-label">Humanized</div> <div class="bubble-text ${shouldTruncate && !this.isExpanded ? 'truncated':''}" id="humanized-text" role="region" aria-labelledby="humanized-label"> ${this.escapeHtml(displayHumanized)}</div> </div> </div> ${shouldTruncate ? ` <a href="#" class="show-more" id="show-more-link" role="button" aria-label="${this.isExpanded ? 'Show less text':'Show more text'}" aria-expanded="${this.isExpanded}"> ${this.isExpanded ? 'Show less':'Show more'}</a> `:''}<div class="bubble-buttons" role="group" aria-label="Actions"> <button class="bubble-button" id="copy-button" type="button" aria-label="Copy humanized text to clipboard"> Copy </button> <button class="bubble-button primary" id="replace-button" type="button" aria-label="Replace selection with humanized text"> Replace Selection </button> </div> <div role="status" aria-live="polite" aria-atomic="true" id="status-message" class="sr-only"></div> `;return bubble;}escapeHtml(text){if(typeof text !== 'string'){return '';}const div = document.createElement('div');div.textContent = text;return div.innerHTML;}announceToScreenReader(message){const statusElement = this.shadowRoot.getElementById('status-message');if(statusElement){statusElement.textContent = '';setTimeout(()=>{statusElement.textContent = message;},100);}}show(originalText,humanizedText,position){if(!this.container){this.init();}this.currentOriginalText = originalText;this.currentHumanizedText = humanizedText;this.isExpanded = false;const existingBubble = this.shadowRoot.querySelector('.bubble');if(existingBubble){existingBubble.remove();}const bubble = this.createBubbleHTML(originalText,humanizedText);this.shadowRoot.appendChild(bubble);this.attachEventListeners();this.position(position);requestAnimationFrame(()=>{bubble.classList.add('visible');this.isVisible = true;this.announceToScreenReader('Text humanization preview opened. Use Tab to navigate between Copy and Replace Selection buttons. Press Escape to close.');requestAnimationFrame(()=>{const copyButton = this.shadowRoot.getElementById('copy-button');if(copyButton){copyButton.focus();}});});}hide(){if(!this.isVisible)return;const bubble = this.shadowRoot.querySelector('.bubble');if(bubble){bubble.classList.remove('visible');setTimeout(()=>{bubble.style.display = 'none';this.isVisible = false;if(this.onClose){this.onClose();}},150);}}position(selectionRect){const bubble = this.shadowRoot.querySelector('.bubble');if(!bubble)return;try{bubble.style.display = 'block';bubble.style.opacity = '0';const bubbleRect = bubble.getBoundingClientRect();const viewportWidth = window.innerWidth;const viewportHeight = window.innerHeight;let top = selectionRect.top - bubbleRect.height - 10;let left = selectionRect.left +(selectionRect.width / 2)-(bubbleRect.width / 2);if(top < 10){top = selectionRect.bottom + 10;}if(left + bubbleRect.width > viewportWidth - 10){left = viewportWidth - bubbleRect.width - 10;}if(left < 10){left = 10;}if(top + bubbleRect.height > viewportHeight - 10){top = viewportHeight - bubbleRect.height - 10;}if(top < 0 || left < 0 || top + bubbleRect.height > viewportHeight || left + bubbleRect.width > viewportWidth){top =(viewportHeight - bubbleRect.height)/ 2;left =(viewportWidth - bubbleRect.width)/ 2;}bubble.style.top = `${Math.max(0,top)}px`;bubble.style.left = `${Math.max(0,left)}px`;bubble.style.opacity = '';}catch(error){console.warn('[Dash Humanizer] Bubble positioning error,using center fallback',error);bubble.style.cssText += ` top:50%;left:50%;transform:translate(-50%,-50%);opacity:1;`;}}attachEventListeners(){const bubble = this.shadowRoot.querySelector('.bubble');const copyButton = this.shadowRoot.getElementById('copy-button');const replaceButton = this.shadowRoot.getElementById('replace-button');const showMoreLink = this.shadowRoot.getElementById('show-more-link');if(bubble){bubble.addEventListener('mouseenter',()=>{if(this.onInteractionStart){this.onInteractionStart();}});bubble.addEventListener('mouseleave',()=>{if(this.onInteractionEnd){this.onInteractionEnd();}});bubble.addEventListener('focusin',()=>{if(this.onInteractionStart){this.onInteractionStart();}});bubble.addEventListener('focusout',(e)=>{if(!bubble.contains(e.relatedTarget)){if(this.onInteractionEnd){this.onInteractionEnd();}}});}if(copyButton){copyButton.addEventListener('click',()=>{if(this.onCopy){this.onCopy(this.currentHumanizedText);this.announceToScreenReader('Humanized text copied to clipboard');}});}if(replaceButton){replaceButton.addEventListener('click',()=>{if(this.onReplace){this.onReplace(this.currentHumanizedText);this.announceToScreenReader('Selection replaced with humanized text');}});}if(showMoreLink){showMoreLink.addEventListener('click',(e)=>{e.preventDefault();this.isExpanded = !this.isExpanded;const bubble = this.shadowRoot.querySelector('.bubble');const currentTop = bubble.style.top;const currentLeft = bubble.style.left;const newBubble = this.createBubbleHTML(this.currentOriginalText,this.currentHumanizedText);bubble.replaceWith(newBubble);newBubble.style.top = currentTop;newBubble.style.left = currentLeft;newBubble.classList.add('visible');this.attachEventListeners();this.attachKeyboardListeners();});}this.attachKeyboardListeners();}attachKeyboardListeners(){const bubble = this.shadowRoot.querySelector('.bubble');if(!bubble)return;const handleKeyDown =(e)=>{if(e.key === 'Escape'){this.hide();}else if(e.key === 'Tab'){this.handleTabNavigation(e);}else if(e.key === 'Enter' || e.key === ' '){const target = e.target;if(target.tagName === 'BUTTON' ||(target.tagName === 'A' && target.getAttribute('role')=== 'button')){e.preventDefault();target.click();}}};bubble.addEventListener('keydown',handleKeyDown);}handleTabNavigation(e){const focusableElements = this.shadowRoot.querySelectorAll('button,a[href],a[role="button"]');const focusableArray = Array.from(focusableElements);const firstElement = focusableArray[0];const lastElement = focusableArray[focusableArray.length - 1];if(e.shiftKey){if(this.shadowRoot.activeElement === firstElement){e.preventDefault();lastElement.focus();}}else{if(this.shadowRoot.activeElement === lastElement){e.preventDefault();firstElement.focus();}}}isShowing(){return this.isVisible;}destroy(){if(this.container && this.container.parentNode){this.container.parentNode.removeChild(this.container);}this.container = null;this.shadowRoot = null;this.isVisible = false;}}if(typeof module !== 'undefined' && module.exports){module.exports = SelectionBubble;}